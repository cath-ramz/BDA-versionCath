{% extends "cliente_base.html" %}

{% block title %}Pagar Factura - Joyería Premium{% endblock %}

{% block extra_css %}
<style>
    body {
        background-color: #f8fafc;
    }

    .page-header {
        background: white;
        padding: 40px 0;
        margin-bottom: 30px;
        border-bottom: 1px solid #e2e8f0;
    }

    .page-title {
        font-size: 2rem;
        font-weight: 700;
        color: #1e293b;
        margin-bottom: 8px;
    }

    .form-container {
        background: white;
        border-radius: 12px;
        padding: 30px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        border: 1px solid #f1f5f9;
        max-width: 600px;
        margin: 0 auto;
    }

    .form-label {
        font-weight: 600;
        color: #1e293b;
        margin-bottom: 8px;
    }

    .form-control, .form-select {
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        padding: 10px 14px;
    }

    .form-control:focus, .form-select:focus {
        border-color: #ff9500;
        box-shadow: 0 0 0 3px rgba(255, 149, 0, 0.1);
        outline: none;
    }

    .info-box {
        background: #f8fafc;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
    }

    .required-field::after {
        content: " *";
        color: #ef4444;
    }
</style>
{% endblock %}

{% block content %}
<div class="page-header">
    <div class="container">
        <h1 class="page-title">
            <i class="bi bi-credit-card"></i> Pagar Factura
        </h1>
        <p class="text-muted">Completa el pago de tu factura</p>
    </div>
</div>

<div class="container">
    <div class="form-container">
        <div class="info-box">
            <h5 class="mb-3">Información de la Factura</h5>
            <div class="row mb-2">
                <div class="col-6"><strong>Folio:</strong></div>
                <div class="col-6">{{ factura.folio if factura.folio else 'N/A' }}</div>
            </div>
            <div class="row mb-2">
                <div class="col-6"><strong>Total Factura:</strong></div>
                <div class="col-6"><strong>${{ "{:,.2f}".format(factura.total or 0) }}</strong></div>
            </div>
            <div class="row mb-2">
                <div class="col-6"><strong>Total Pagado:</strong></div>
                <div class="col-6">${{ "{:,.2f}".format(total_pagado or 0) }}</div>
            </div>
            <div class="row">
                <div class="col-6"><strong>Pendiente:</strong></div>
                <div class="col-6">
                    <strong class="{% if pendiente > 0 %}text-danger{% else %}text-success{% endif %}">
                        ${{ "{:,.2f}".format(pendiente or 0) }}
                    </strong>
                </div>
            </div>
        </div>

        <form id="formPago">
            <input type="hidden" id="id_factura" value="{{ factura.id_factura }}">
            
            <div class="mb-3">
                <label for="importe" class="form-label required-field">Importe a Pagar</label>
                <input type="number" class="form-control" id="importe" name="importe" 
                       step="0.01" min="0.01" max="{{ pendiente }}" 
                       value="{{ pendiente if pendiente > 0 else 0 }}" required>
                <small class="text-muted">Monto máximo: ${{ "{:,.2f}".format(pendiente or 0) }}</small>
            </div>

            <div class="mb-3">
                <label for="id_metodo_pago" class="form-label required-field">Método de Pago</label>
                <select class="form-select" id="id_metodo_pago" name="id_metodo_pago" required>
                    <option value="">Seleccione un método de pago</option>
                    {% for metodo in metodos_pago %}
                    <option value="{{ metodo.id_metodo_pago if metodo.id_metodo_pago else metodo[0] }}">
                        {{ metodo.nombre_metodo_pago if metodo.nombre_metodo_pago else metodo[1] }}
                    </option>
                    {% endfor %}
                </select>
            </div>

            <div class="d-flex justify-content-end gap-3 mt-4">
                <a href="{{ url_for('cliente_facturas') }}" class="btn btn-secondary">
                    <i class="bi bi-x-circle"></i> Cancelar
                </a>
                <button type="submit" class="btn btn-primary">
                    <i class="bi bi-credit-card"></i> Registrar Pago
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.getElementById('formPago').addEventListener('submit', function(e) {
        e.preventDefault();

        const data = {
            id_factura: parseInt(document.getElementById('id_factura').value),
            importe: parseFloat(document.getElementById('importe').value),
            id_metodo_pago: parseInt(document.getElementById('id_metodo_pago').value)
        };

        if (!data.id_metodo_pago) {
            alert('Por favor seleccione un método de pago');
            return;
        }

        if (data.importe <= 0) {
            alert('El importe debe ser mayor a cero');
            return;
        }

        const btnSubmit = this.querySelector('button[type="submit"]');
        btnSubmit.disabled = true;
        btnSubmit.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Procesando...';

        fetch('/api/cliente/pago/registrar', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        })
        .then(response => {
            if (!response.ok) {
                return response.json().then(err => Promise.reject(err));
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                // Vaciar el carrito después de un pago exitoso
                fetch('/api/carrito/vaciar', { method: 'POST' })
                    .then(() => {
                        // Actualizar el badge del carrito si existe
                        if (typeof window.actualizarBadgeCarrito === 'function') {
                            window.actualizarBadgeCarrito(0);
                        }
                        // Limpiar sessionStorage del carrito pendiente si existe
                        sessionStorage.removeItem('carrito_pendiente');
                        sessionStorage.removeItem('pedidoPendiente');
                    })
                    .catch(err => {
                        console.error('Error vaciando carrito:', err);
                    })
                    .finally(() => {
                        alert('¡Pago registrado exitosamente!');
                        window.location.href = '{{ url_for("cliente_facturas") }}';
                    });
            } else {
                alert('Error: ' + (data.error || 'No se pudo registrar el pago'));
                btnSubmit.disabled = false;
                btnSubmit.innerHTML = '<i class="bi bi-credit-card"></i> Registrar Pago';
            }
        })
        .catch(error => {
            console.error('Error:', error);
            const errorMsg = error.error || error.message || 'Error al registrar el pago';
            alert('Error: ' + errorMsg);
            btnSubmit.disabled = false;
            btnSubmit.innerHTML = '<i class="bi bi-credit-card"></i> Registrar Pago';
        });
    });
</script>
{% endblock %}

